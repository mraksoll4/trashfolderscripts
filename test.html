<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HamsterKombat Game Code Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
            text-align: center;
        }
        #spinner {
            display: none;
            font-size: 18px;
            color: #555;
        }
        #progress-container {
            display: none;
            width: 100%;
            background-color: #f3f3f3;
            margin-top: 20px;
            border-radius: 5px;
        }
        #progress-bar {
            width: 0%;
            height: 30px;
            background-color: #4caf50;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        #generated-codes {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
            text-align: left;
            max-width: 600px;
            margin: 20px auto;
        }
        .code-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .copy-button {
            margin-left: 10px;
        }
        #copy-all-button {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>HamsterKombat Game Code Generator</h1>
    <form id="generate-key-form">
        <button type="submit" id="generate-button">Generate 4 codes</button>
    </form>

    <div id="spinner">Loading...</div>

    <div id="progress-container">
        <div id="progress-bar" aria-valuenow="0"></div>
    </div>

    <div id="generated-codes" class="d-none"></div>
    <button id="copy-all-button" class="d-none">Copy all</button>

    <script>
        document.getElementById("generate-key-form").addEventListener("submit", async function(o) {
            o.preventDefault();
            const generatedCodesDiv = document.getElementById("generated-codes");
            const spinner = document.getElementById("spinner");
            const progressContainer = document.getElementById("progress-container");
            const generateButton = document.getElementById("generate-button");
            const copyAllButton = document.getElementById("copy-all-button");

            // Initialize the interface
            generatedCodesDiv.classList.add("d-none");
            generatedCodesDiv.innerHTML = "";
            spinner.classList.remove("d-none");
            progressContainer.style.display = 'block'; // Show progress bar
            updateProgressBar(0);
            generateButton.disabled = true;

            try {
                // Start parallel requests
                const tokens = await Promise.all([authenticateClient(), authenticateClient(), authenticateClient(), authenticateClient()]);
                updateProgressBar(25);
                await Promise.all(tokens.map(token => registerEvent(token)));
                updateProgressBar(50);
                const codes = await Promise.all(tokens.map(token => createCode(token)));
                updateProgressBar(100);

                // Update the interface after completion
                spinner.classList.add("d-none");
                generatedCodesDiv.classList.remove("d-none");
                copyAllButton.classList.remove("d-none");

                // Add codes to container
                codes.forEach(code => {
                    const codeBox = document.createElement('div');
                    codeBox.className = 'code-box';
                    codeBox.innerHTML = `
                        ${code}
                        <button class="copy-button" data-code="${code}">Copy</button>
                    `;
                    generatedCodesDiv.appendChild(codeBox);
                });

                // Hide progress bar with delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 500);
            } catch (error) {
                console.error("Error generating codes:", error);
                spinner.classList.add("d-none");
                generatedCodesDiv.textContent = "Error generating codes. Please try again.";
                generatedCodesDiv.classList.remove("d-none");
            } finally {
                generateButton.disabled = false;
            }
        });

        function updateProgressBar(percentage) {
            const progressBar = document.getElementById("progress-bar");
            progressBar.style.width = `${percentage}%`;
            progressBar.setAttribute("aria-valuenow", percentage);
        }

        async function authenticateClient() {
            const clientId = generateClientId();
            try {
                const response = await fetch("https://api.gamepromo.io/promo/login-client", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8"
                    },
                    body: JSON.stringify({
                        appToken: "d28721be-fd2d-4b45-869e-9f253b554e50",
                        clientId: clientId,
                        clientOrigin: "deviceid"
                    })
                });
                if (!response.ok) throw new Error("Network response was not ok");
                const data = await response.json();
                await new Promise(resolve => setTimeout(resolve, 21000)); // Delay
                return data.clientToken;
            } catch (error) {
                console.error("Error logging in client:", error.message);
                await new Promise(resolve => setTimeout(resolve, 5000)); // Delay
                return authenticateClient();
            }
        }

        async function registerEvent(token) {
            let attempts = 0;
            while (attempts < 10) {
                try {
                    const response = await fetch("https://api.gamepromo.io/promo/register-event", {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json; charset=utf-8"
                        },
                        body: JSON.stringify({
                            promoId: "43e35910-c168-4634-ad4f-52fd764a843f",
                            eventId: generateEventId(),
                            eventOrigin: "undefined"
                        })
                    });
                    if (!response.ok) throw new Error("Network response was not ok");
                    const data = await response.json();
                    if (data.hasCode) return;
                    attempts++;
                    updateProgressBar(25 + (attempts * 2.5));
                    await new Promise(resolve => setTimeout(resolve, 20000)); // Delay
                } catch (error) {
                    console.error("Error registering event:", error.message);
                    await new Promise(resolve => setTimeout(resolve, 5000)); // Delay
                }
            }
            throw new Error("Maximum number of event registration attempts exceeded");
        }

        async function createCode(token) {
            while (true) {
                try {
                    const response = await fetch("https://api.gamepromo.io/promo/create-code", {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json; charset=utf-8"
                        },
                        body: JSON.stringify({
                            promoId: "43e35910-c168-4634-ad4f-52fd764a843f"
                        })
                    });
                    if (!response.ok) throw new Error("Network response was not ok");
                    const data = await response.json();
                    if (data.promoCode) return data.promoCode;
                } catch (error) {
                    console.error("Error creating code:", error.message);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Delay
                }
            }
        }

        function generateClientId() {
            const timestamp = Date.now();
            const randomPart = Array.from({ length: 19 }, () => Math.floor(Math.random() * 10)).join("");
            const randomSuffix = Math.floor(Math.random() * 1000000);
            return `${timestamp}-${randomPart}-${randomSuffix}`;
        }

        function generateEventId() {
            return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (char) {
                const random = Math.random() * 16 | 0;
                return (char === "x" ? random : random & 3 | 8).toString(16);
            });
        }

        // Copy code
        document.getElementById("generated-codes").addEventListener("click", function(event) {
            if (event.target.classList.contains("copy-button")) {
                const code = event.target.getAttribute("data-code");
                navigator.clipboard.writeText(code).then(() => {
                    alert(`Code "${code}" copied to clipboard.`);
                }).catch(err => {
                    console.error("Error copying code:", err);
                });
            }
        });

        // Copy all codes
        document.getElementById("copy-all-button").addEventListener("click", function() {
            const codes = Array.from(document.querySelectorAll(".code-box")).map(box => box.textContent.trim().split('\n')[0]);
            navigator.clipboard.writeText(codes.join('\n')).then(() => {
                alert("All codes copied to clipboard.");
            }).catch(err => {
                console.error("Error copying all codes:", err);
            });
        });
    </script>
</body>
</html>
